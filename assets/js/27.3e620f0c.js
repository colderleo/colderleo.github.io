(window.webpackJsonp=window.webpackJsonp||[]).push([[27],{692:function(s,n,a){"use strict";a.r(n);var e=a(16),t=Object(e.a)({},(function(){var s=this,n=s.$createElement,a=s._self._c||n;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h3",{attrs:{id:"概念"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#概念"}},[s._v("#")]),s._v(" 概念")]),s._v(" "),a("ul",[a("li",[a("p",[s._v("参考："),a("a",{attrs:{href:"https://www.jianshu.com/p/0f3b39a125eb",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://www.jianshu.com/p/0f3b39a125eb"),a("OutboundLink")],1)])]),s._v(" "),a("li",[a("p",[s._v("chip：芯片，一个cpu芯片上可以包含多个cpu core，比如四核，表示一个chip里4个core。")])]),s._v(" "),a("li",[a("p",[s._v("socket：芯片插槽，颗，跟上面的chip一样。两颗四核，就表示总共8个core")])]),s._v(" "),a("li",[a("p",[s._v("core：包含在一个cpu芯片里的多个核心")])]),s._v(" "),a("li",[a("p",[s._v("LCPU：逻辑cpu，一个core里可以做多个逻辑cpu，每个LCPU只有寄存器，没有计算单元，类似于分时复用，就是人们常说的线程。4核8线程，就是4个core，一个core里两个线程。")])])]),s._v(" "),a("p",[s._v("下图为一个四核八线程的chip：")]),s._v(" "),a("p",[a("img",{attrs:{src:"pic/webp",alt:"img"}})]),s._v(" "),a("h3",{attrs:{id:"numastat查看当前numa状态"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#numastat查看当前numa状态"}},[s._v("#")]),s._v(" numastat查看当前numa状态：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("$ numastat\n                           node0           node1\nnuma_hit              "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1296554257")]),s._v("       "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("918018444")]),s._v("\nnuma_miss                "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8541758")]),s._v("        "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("40297198")]),s._v("\nnuma_foreign            "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("40288595")]),s._v("         "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8550361")]),s._v("\ninterleave_hit             "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("45651")]),s._v("           "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("45918")]),s._v("\nlocal_node            "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1231897031")]),s._v("       "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("835344122")]),s._v("\nother_node              "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("64657226")]),s._v("        "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("82674322")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("12345678")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 说明：")]),s._v("\nnuma_hit—命中的，也就是为这个节点成功分配本地内存访问的内存大小\nnuma_miss—把内存访问分配到另一个node节点的内存大小，这个值和另一个node的numa_foreign相对应。\nnuma_foreign–另一个Node访问我的内存大小，与对方node的numa_miss相对应\nlocal_node----这个节点的进程成功在这个节点上分配内存访问的大小\nother_node----这个节点的进程 在其它节点上分配的内存访问大小\n很明显，miss值和foreign值越高，就要考虑绑定的问题。\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br")])]),a("h3",{attrs:{id:"numa默认的内存分配策略"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#numa默认的内存分配策略"}},[s._v("#")]),s._v(" numa默认的内存分配策略：")]),s._v(" "),a("p",[s._v("1.缺省(default)：总是在本地节点分配（分配在当前进程运行的节点上）；\n2.绑定(bind)：强制分配到指定节点上；\n3.交叉(interleave)：在所有节点或者指定的节点上交织分配；\n4.优先(preferred)：在指定节点上分配，失败则在其他节点上分配。")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("$ numactl --show\npolicy: default\npreferred node: current\nphyscpubind: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("12")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("13")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("17")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("18")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("19")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("23")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("24")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("25")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("26")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("27")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("28")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("29")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("30")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("31")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("32")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("33")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("34")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("35")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("36")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("37")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("38")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("39")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("40")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("41")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("42")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("43")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("44")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("45")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("46")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("47")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("48")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("49")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("50")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("51")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("52")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("53")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("54")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("55")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("56")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("57")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("58")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("59")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("60")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("61")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("62")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("63")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("65")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("66")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("67")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("68")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("69")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("70")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("71")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("72")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("73")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("74")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("75")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("76")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("77")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("78")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("79")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("81")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("82")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("83")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("84")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("85")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("86")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("87")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("88")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("89")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("90")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("91")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("92")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("93")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("94")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("95")]),s._v(" \ncpubind: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" \nnodebind: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" \nmembind: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" \n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("h3",{attrs:{id:"执行程序时指定numa配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#执行程序时指定numa配置"}},[s._v("#")]),s._v(" 执行程序时指定numa配置：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 运行 test_program 程序，参数是 argument，绑定到 node 0 的 CPU 和 node 1 的内存")]),s._v("\nnumactl --cpubind"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" --membind"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" test_program arguments\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 在 processor 0-4，8-12 上运行 test_program")]),s._v("\nnumactl --physcpubind"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("-4,8-12 test_program arguments\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 轮询分配内存")]),s._v("\nnumactl --interleave"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("all test_program arguments\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 优先考虑从 node 1 上分配内存")]),s._v("\nnumactl --preferred"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br")])]),a("p",[s._v("对于mysql等占用内存比较多的应用，在numa local 内存不足时，上述策略会优先淘汰/Swap本Chip上的内存，使得大量有用内存被换出。当被换出页被访问时就会出现数据库响应时间飙高甚至阻塞。参考"),a("a",{attrs:{href:"https://www.cnblogs.com/cenalulu/p/4358802.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://www.cnblogs.com/cenalulu/p/4358802.html"),a("OutboundLink")],1)]),s._v(" "),a("p",[s._v("解决方法，修改为interleave：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("numactl --interleave"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("all\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])])])}),[],!1,null,null,null);n.default=t.exports}}]);